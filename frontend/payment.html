<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Thanh to√°n - SentinelVN</title>
  <style>
    * { box-sizing: border-box; margin: 0; padding: 0; }
    body {
      font-family: Arial, sans-serif;
      background: #0f172a;
      color: white;
      min-height: 100vh;
      display: flex;
      justify-content: center;
      align-items: center;
    }
    .card {
      background: #1e293b;
      border-radius: 16px;
      padding: 2rem;
      text-align: center;
      width: 100%;
      max-width: 420px;
      box-shadow: 0 8px 32px rgba(0,0,0,0.4);
    }
    h2 { margin-bottom: 0.5rem; font-size: 1.4rem; }
    .subtitle { color: #94a3b8; font-size: 0.9rem; margin-bottom: 1.5rem; }
    .plan-btn {
      display: inline-block;
      background: #3b82f6;
      color: white;
      border: none;
      padding: 0.7rem 2rem;
      border-radius: 8px;
      font-size: 1rem;
      cursor: pointer;
      margin: 0.4rem;
      transition: background 0.2s;
    }
    .plan-btn:hover { background: #2563eb; }
    .plan-btn.pro { background: #7c3aed; }
    .plan-btn.pro:hover { background: #6d28d9; }
    .qr-box {
      background: white;
      border-radius: 12px;
      padding: 1rem;
      display: inline-block;
      margin: 1rem 0;
    }
    .qr-box img { width: 220px; height: 220px; display: block; }
    .amount { font-size: 1.5rem; font-weight: bold; color: #38bdf8; margin-bottom: 0.4rem; }
    .order-id { color: #64748b; font-size: 0.8rem; margin-bottom: 1rem; }
    .link-btn {
      display: inline-block;
      background: #0ea5e9;
      color: white;
      padding: 0.6rem 1.4rem;
      border-radius: 8px;
      text-decoration: none;
      font-size: 0.9rem;
    }
    .loading { color: #94a3b8; padding: 1.5rem; }
    .error-msg { color: #f87171; padding: 1rem; }
    .success-box { background: #14532d; border-radius: 12px; padding: 1.5rem; color: #86efac; margin-bottom: 1rem; }
    .cancel-box { background: #450a0a; border-radius: 12px; padding: 1.5rem; color: #fca5a5; margin-bottom: 1rem; }
    .license-key {
      background: #0f172a;
      border: 1px solid #334155;
      border-radius: 8px;
      padding: 0.8rem;
      font-family: monospace;
      font-size: 1.1rem;
      color: #fbbf24;
      margin: 0.5rem 0;
      letter-spacing: 2px;
    }
    .back-link { color: #38bdf8; text-decoration: none; font-size: 0.9rem; }
    #qr-section { display: none; }
    #result-section { display: none; }
    
  </style>
</head>
<body>
<div class="card">
  <h2>üíé N√¢ng c·∫•p t√†i kho·∫£n</h2>
  <p class="subtitle">Ch·ªçn g√≥i b·∫°n mu·ªën mua</p>

  <!-- B∆∞·ªõc 1: Ch·ªçn g√≥i -->
  <div id="plan-section">
    <button class="plan-btn" onclick="startPayment('PREMIUM')">
      ‚≠ê PREMIUM ‚Äî 75.000 ‚Ç´ / 30 ng√†y
    </button>
    <br>
    <button class="plan-btn pro" onclick="startPayment('PRO')">
      üöÄ PRO ‚Äî 500.000 ‚Ç´ / 30 ng√†y
    </button>
  </div>

  <!-- B∆∞·ªõc 2: Loading -->
  <div id="loading-section" style="display:none">
    <p class="loading">‚è≥ ƒêang t·∫°o m√£ QR...</p>
  </div>

  <!-- B∆∞·ªõc 3: Hi·ªÉn th·ªã QR -->
  <div id="qr-section">
    <p style="color:#94a3b8; margin-bottom:0.5rem">Qu√©t m√£ QR ƒë·ªÉ thanh to√°n</p>
    <div class="qr-box">
      <img id="qr-image" src="" alt="QR Code">
    </div>
    <div class="amount" id="amount-text"></div>
    <div class="order-id">M√£ ƒë∆°n: <span id="order-code"></span></div>
    <a id="checkout-link" class="link-btn" href="#" target="_blank">üîó Thanh to√°n qua link</a>
    <br><br>
    <button onclick="checkPayment()" style="background:#22c55e;color:white;border:none;padding:0.6rem 1.5rem;border-radius:8px;cursor:pointer;font-size:0.9rem">
      ‚úÖ T√¥i ƒë√£ thanh to√°n xong
    </button>
    <br><br>
    <a href="/index.html" class="back-link">‚Üê Quay l·∫°i</a>
  </div>

  <!-- B∆∞·ªõc 4: K·∫øt qu·∫£ -->
  <div id="result-section">
    <div id="result-content"></div>
    <br>
    <a href="/index.html" class="back-link">‚Üê Quay v·ªÅ trang ch·ªß</a>
  </div>
</div>

<script>
  // ‚ö†Ô∏è QUAN TR·ªåNG: ƒê·ªïi URL n√†y th√†nh backend Render c·ªßa b·∫°n
  const BACKEND_URL = 'https://sentinelvn.onrender.com';

  let currentPaymentId = null;
  let currentPlan = null;

  // Ki·ªÉm tra n·∫øu PayOS redirect v·ªÅ sau thanh to√°n
  window.addEventListener('DOMContentLoaded', () => {
    const params = new URLSearchParams(window.location.search);
    const status = params.get('status');
    const id = params.get('id');

    if (status === 'success' && id) {
      currentPaymentId = id;
      document.getElementById('plan-section').style.display = 'none';
      document.getElementById('loading-section').style.display = 'block';
      document.getElementById('loading-section').innerHTML = '<p class="loading">‚è≥ ƒêang x√°c nh·∫≠n thanh to√°n...</p>';
      verifyPayment(id);
    } else if (status === 'cancelled') {
      document.getElementById('plan-section').style.display = 'none';
      showResult('cancel', null);
    }
  });

  // B·∫Øt ƒë·∫ßu t·∫°o thanh to√°n
  async function startPayment(plan) {
    currentPlan = plan;
    document.getElementById('plan-section').style.display = 'none';
    document.getElementById('loading-section').style.display = 'block';

    try {
      const res = await fetch(`${BACKEND_URL}/api/payment/create`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        credentials: 'include',   // quan tr·ªçng! ƒë·ªÉ g·ª≠i session cookie
        body: JSON.stringify({ plan }),
      });

      const data = await res.json();

      if (!data.success) {
        throw new Error(data.message || 'L·ªói t·∫°o ƒë∆°n h√†ng');
      }

      currentPaymentId = data.paymentId;

      // Hi·ªÉn th·ªã QR
      document.getElementById('loading-section').style.display = 'none';
      document.getElementById('qr-section').style.display = 'block';
      document.getElementById('qr-image').src = data.qrCode;
      document.getElementById('checkout-link').href = data.checkoutUrl;
      document.getElementById('order-code').textContent = data.paymentId;

      const amounts = { PREMIUM: '75.000 ‚Ç´', PRO: '500.000 ‚Ç´' };
      document.getElementById('amount-text').textContent = amounts[plan] || '';

    } catch (err) {
      document.getElementById('loading-section').innerHTML =
        `<p class="error-msg">‚ùå ${err.message}<br><br><a href="/payment.html" class="back-link">Th·ª≠ l·∫°i</a></p>`;
      console.error(err);
    }
  }

  // Khi user b·∫•m "T√¥i ƒë√£ thanh to√°n xong"
  async function checkPayment() {
    if (!currentPaymentId) return;
    document.getElementById('qr-section').style.display = 'none';
    document.getElementById('loading-section').style.display = 'block';
    document.getElementById('loading-section').innerHTML = '<p class="loading">‚è≥ ƒêang x√°c nh·∫≠n...</p>';
    verifyPayment(currentPaymentId);
  }

  // G·ªçi backend ƒë·ªÉ x√°c nh·∫≠n thanh to√°n
  async function verifyPayment(paymentId) {
    try {
      const res = await fetch(`${BACKEND_URL}/api/payment/return`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        credentials: 'include',
        body: JSON.stringify({ paymentId }),
      });

      const data = await res.json();

      document.getElementById('loading-section').style.display = 'none';

      if (data.success) {
        showResult('success', data.license);
      } else {
        showResult('pending', null, data.message);
      }

    } catch (err) {
      document.getElementById('loading-section').innerHTML =
        '<p class="error-msg">‚ùå L·ªói x√°c nh·∫≠n. Vui l√≤ng th·ª≠ l·∫°i.<br><br><a href="/payment.html" class="back-link">Th·ª≠ l·∫°i</a></p>';
    }
  }

  function showResult(type, license, message) {
    document.getElementById('result-section').style.display = 'block';
    document.getElementById('loading-section').style.display = 'none';
    document.getElementById('qr-section').style.display = 'none';
    document.getElementById('plan-section').style.display = 'none';

    if (type === 'success') {
      document.getElementById('result-content').innerHTML = `
        <div class="success-box">
          <p style="font-size:1.3rem;margin-bottom:0.5rem">‚úÖ Thanh to√°n th√†nh c√¥ng!</p>
          <p style="margin-bottom:1rem">License key c·ªßa b·∫°n:</p>
          <div class="license-key">${license?.key || 'N/A'}</div>
          <p style="font-size:0.8rem;color:#86efac;margin-top:0.5rem">
            H·∫°n s·ª≠ d·ª•ng: ${license?.expiresAt ? new Date(license.expiresAt).toLocaleDateString('vi-VN') : 'N/A'}
          </p>
        </div>`;
    } else if (type === 'cancel') {
      document.getElementById('result-content').innerHTML = `
        <div class="cancel-box">
          <p style="font-size:1.2rem">‚ùå B·∫°n ƒë√£ h·ªßy thanh to√°n.</p>
        </div>`;
    } else {
      document.getElementById('result-content').innerHTML = `
        <div class="cancel-box">
          <p>‚ö†Ô∏è ${message || 'Ch∆∞a x√°c nh·∫≠n ƒë∆∞·ª£c thanh to√°n.'}</p>
          <p style="font-size:0.85rem;margin-top:0.5rem">N·∫øu b·∫°n ƒë√£ chuy·ªÉn ti·ªÅn, vui l√≤ng ƒë·ª£i v√†i ph√∫t r·ªìi th·ª≠ l·∫°i.</p>
          <br>
          <a href="/payment.html" class="back-link" style="color:#fca5a5">‚Üê Th·ª≠ l·∫°i</a>
        </div>`;
    }
  }
</script>
</body>
</html>